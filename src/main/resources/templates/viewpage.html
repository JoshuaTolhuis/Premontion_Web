<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.1.0/cytoscape.min.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link th:href="@{/stylesheets/viewpage.css}" rel="stylesheet" />
    <!-- <link href="../static/stylesheets/viewpage.css" rel="stylesheet"/> -->
</head>
<body>
<ul>
    <li>
        <a href = "homepage.html" th:href="@{/home}">
            <img class="logo" alt="Premonition home" src="../static/images/logo.jpeg" th:src="@{/images/logo.jpeg}">
        </a>
    <li>
        <a href="homepage.html" th:href="@{/home}">Home</a>
    <li>
        <a href="premonition.html" th:href="@{/premonition}">Premonition</a>
    </li>
    <li>
        <a href="aboutus.html" th:href="@{/aboutus}">About Us</a>
    </li>
</ul>
<div id="cy" style="width: 100%; height: 100%; position: absolute; top: 0px; left: 0px;"></div>

<div class = "loading" id="loading">
    <img class="loading_img" id="loading_img" width="50%" height="50%" th:src="@{/images/loading.gif}" alt="Crunching numbers and creating networks."/>
    <div class="status_text" id ="status_text">Initializing</div>
</div>
<script>

    var dataLocation = "[[${location}]]";
    var tempID = "12345" //Temp var delete later.
    var tempCounter = 0;
    var sessionID = "[[${ID}]]";
    var fetchedData = {};
    var url = "check_results"
    var status_text = document.getElementById('status_text');
    var loading_div = document.getElementById('loading');
    var cy_canvas =  document.getElementById('cy');
    cy_canvas.hidden = true; //Set the cytoscape canvas to hide when page is first loaded.
    var cycle_cy = true; //cycle cy initialization? Once per new set of data.

    var get_data = function (){
        $.ajax({
            url: url + "?user_id=" + tempID,
            dataType: "json",
            success: function(data){
                fetchedData = data;
                // console.log(data);
                // console.log("fetched data length " + Object.keys(fetchedData).length)
            },
            error: function(){
                console.log("There was an error.");
            }
        }).then(function(){
            if(Object.keys(fetchedData).length > 1) {
                //Turn the loading elements off.
                // loading_img.hidden = true;
                // status_text.hidden = true;
                loading_div.hidden = true;
                cy_canvas.hidden = false; //Show cytoscape canvas
                if(cycle_cy) {
                    var cy = cytoscape({container: document.getElementById('cy'), elements: fetchedData});
                    cycle_cy = false;
                }
            }
            else{
                //Turn the loading elements on.
                // loading_img.hidden = false;
                // status_text.hidden = false;
                loading_div.hidden = false;
                //Change status text
                status_text.innerHTML = fetchedData.status;
                cy_canvas.hidden = true; //Hide cytoscape canvas
                cycle_cy = true;
                console.log("Put loading screen here")
            }
        });
    }

    // Retrieve data every 2 seconds and update the results tables
    window.setInterval(function(){
        get_data();
        tempCounter += 1;
        if(tempCounter > 3) tempID = "123456";
    }, 2000);

    // draw rectangle using general canvas method

    function draw() {
        var canvas = document.querySelector('canvas[data-id="layer2-node"]');
        var context = canvas.getContext('2d');
        context.fillRect(canvas.width / 2.1, 60, 30, 30);
        requestAnimationFrame(draw);
    }

</script>

</body>
</html>