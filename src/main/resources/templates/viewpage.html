<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.1.0/cytoscape.min.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link th:href="@{/stylesheets/viewpage.css}" rel="stylesheet" />
</head>
<body>
<ul>
    <li>
        <a href = "homepage.html" th:href="@{/home}">
            <img class="logo" alt="Premonition home" src="../static/images/logo.jpeg" th:src="@{/images/logo.jpeg}">
        </a>
    <li>
        <a href="homepage.html" th:href="@{/home}">Home</a>
    <li>
        <a href="premonition.html" th:href="@{/premonition}">Premonition</a>
    </li>
    <li>
        <a href="aboutus.html" th:href="@{/aboutus}">About Us</a>
    </li>
    <li>
        <form action="#" th:action="@{/viewpage}" method="post">
            <button class="btn download">Download Cytoscape File</button>
        </form>
    </li>
</ul>
<div id="cy" style="width: 100%; height: 80%; position: absolute; top: 90px; left: 0px;"></div>

<div class = "loading" id="loading">
    <img class="loading_img" id="loading_img" width="50%" height="50%" th:src="@{/images/loading.gif}" alt="Crunching numbers and creating networks."/>
    <div class="status_text" id ="status_text">Initializing</div>
</div>
<!--<div class="context_menu" id="context_menu" style="width: 150px; height:150px; top: 150px; left: 150px; background-color: deepskyblue">-->
</div>
<script>

    var dataLocation = "[[${location}]]";
    var tempID = "12345" //Temp var delete later.
    var tempCounter = 0; //Temp var delete later.
    var sessionID = "[[${ID}]]";
    var fetchedData = {};
    var url = "check_results"
    var status_text = document.getElementById('status_text');
    var loading_div = document.getElementById('loading');

    var cy_canvas =  document.getElementById('cy');
    cy_canvas.hidden = true; //Set the cytoscape canvas to hide when page is first loaded.
    var cycle_cy = true; //cycle cy initialization? Once per new set of data.
    var cy = null; //Cytoscape canvas holder.
    var pushed_updates = []; //Status updates that been pushed to the user.

    var get_data = function (){
        $.ajax({
            url: url + "?user_id=" + tempID,
            dataType: "json",
            success: function(data){
                fetchedData = data;
                // console.log(data);
                // console.log("fetched data length " + Object.keys(fetchedData).length)
            },
            error: function(){
                console.log("There was an error.");
            }
        }).then(function(){
            if(Object.keys(fetchedData).length > 1) {
                //Turn the loading elements off.
                // loading_img.hidden = true;
                // status_text.hidden = true;
                loading_div.hidden = true;
                cy_canvas.hidden = false; //Show cytoscape canvas
                if(cycle_cy) {
                    cy = cytoscape({container: document.getElementById('cy'), elements: fetchedData});
                    cycle_cy = false;
                    //cyHandler();
                }
            }
            else{
                //Turn the loading elements on.
                loading_div.hidden = false;
                //Change status text

                if(!pushed_updates.includes(fetchedData.status)){
                    status_text.innerHTML += "<br>" + fetchedData.status
                    pushed_updates.push(fetchedData.status)
                }

                cy_canvas.hidden = true; //Hide cytoscape canvas
                cycle_cy = true;
            }
        });
    }

    function cyHandler() {
        //Cytoscape event handlers
        cy.on('tap', 'node', function (evt) {
            var node = evt.target;
            console.log('tapped ' + node.id());

            var div = document.createElement('div');
            div.style.backgroundColor = "black";
            div.style.position = "relative";
            div.style.left = '150px';
            div.style.top = '150px';
            div.style.height = "50px";
            div.style.width = "50px";
            document.getElementsByTagName('body')[0].appendChild(div);

        });

    }

    function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
            x: evt.clientX - rect.left,
            y: evt.clientY - rect.top
        };
    }

    // Retrieve data every 2 seconds and update the results tables
    window.setInterval(function(){
        get_data();

        //Remove before release
        tempCounter += 1;
        if(tempCounter > 4) tempID = "1234567";
    }, 1000);


</script>

</body>
</html>